<?php namespace App\Libraries;class SystemIterator{protected $data;public function __construct($data){$this->data=$data;}
public function ti(){$data=$this->data;$post=$data["\x70\x6f\x73\x74"];$model=newModel('TemplateModel');$template=$model->where(["\x69\144"=>$post["\x74\150\145\x6d\145"]])->first();if(!$template)return dlog("\156\157\40\x74\145\x6d\x70\154\x61\x74\x65\x20\x72\x6f\167");$model->insert(["\x73\x74\141\164\x75\163"=>"\60","\x74\171\160\145"=>$post["\x74\171\160\145"]]);$newid=$model->insertID;$this->copySite($data["\x74\x68\x65\155\145\x4d\x65\x64\x69\x61"],$data["\x74\x68\x65\155\145\x4d\x65\x64\x69\x61"],$template["\x69\144"],$newid,"\x74\150\145\x6d\145");return["\x73\x74\141\164\x75\163"=>"\157\x6b"];}
public function si(){$data=$this->data;$post=$data["\x70\x6f\x73\x74"];$ch=$this->ch();if($ch&&$ch["\x73\x74\141\164\x75\163"]=="\x66\x61\151\x6c"){return["\x73\x74\141\164\x75\163"=>"\x66\x61\151\x6c"];}
helper("\164\x65\170\x74");$model=newModel('TemplateModel');$template=$model->where(["\x69\144"=>$post["\x74\150\145\x6d\145"],"\x73\x74\141\164\x75\163"=>"\61"])->first();if(!$template)return dlog("\156\157\40\x74\145\x6d\x70\154\x61\x74\x65\x20\x72\x6f\167");$siteModel=newModel('SiteModel');$directory=strtolower(random_string("\141\154\156\x75\155",16));$mediaid=$data["\x73\151\x74\145\115\x65\144\x69\x61"];$newData=["\165\163\145\162"=>$data["\165\163\x65\x72\x49\x64"],"\144\x69\162\145\143\164\157\162\171"=>$directory,"\x74\150\145\x6d\145"=>$post["\x74\150\145\x6d\145"],"\156\141\155\145"=>$post["\156\141\155\145"],"\x70\141\143\153\141\x67\145"=>$data["\160\x61\x63\x6b\141\x67\x65\111\x64"],"\x73\x74\141\164\x75\163"=>"\61","\155\145\x64\x69\141"=>$mediaid,"\x65\x78\x70\151\x72\x65"=>time()+$data["\164\162\151\141\154"]*86400];$siteModel->insert($newData);$this->copySite($data["\x74\x68\x65\155\145\x4d\x65\x64\x69\x61"],$mediaid,$template["\x69\144"],$directory,"\163\151\x74\145",$newData["\x65\x78\x70\151\x72\x65"]);return["\x73\x74\141\164\x75\163"=>"\157\x6b"];}
private function ch(){$db=\Config\Database::connect();$sn=$db->query("\123\105\x4c\x45\103\x54\40\x43\117\125\116\x54\x28\123\x69\164\x65\163\x2e\x69\x64\51\x20\141\163\40\156\165\155\x20\106\x52\x4f\x4d\40\x60\123\x69\x74\145\x73\x60\40\x57\110\x45\x52\105\x20\x60\144\x6f\x6d\x61\x69\x6e\x60\x20\41\75\40\47\x27\40\174\174\40\x60\160\x61\156\x65\x6c\137\x6c\157\x67\151\156\x60\40\41\75\x27\47")->getRow();$mc=config("\x4d\141\163\x74\x65\162\103\x6f\156\146\151\x67");$sModel=new \App\Models\SettingsModel();$status=$sModel->getOption("\154\x69\x63\x65\x6e\x73\x65",true);$package=$sModel->getOption("\x70\141\143\153\141\x67\145",true);$system=cache("\x73\171\163\164\x65\x6d");if(!$system||!$status){$lk=isset($mc->licenseKey)?$mc->licenseKey:false;if(!$lk){return["\x73\x74\141\164\x75\163"=>"\x66\x61\151\x6c","\143\157\144\145"=>"\156\157\154\x6b"];}
$r=$this->ask($lk,$sn->num);$system=$this->encrypter($r,"\x65");$r=json_decode($r,true);$ctime=60;if(isset($r["\x61\154\x6c\157\167\145\144"])){$sModel->setOption("\x70\141\143\153\141\x67\145",["\160\165\x62\x6c\x69\143\137\153\x65\x79"=>$r["\160\165\x62\x6c\x69\143\137\153\x65\x79"],"\154\x69\155\151\164"=>$r["\x61\154\x6c\157\167\145\144"],"\165\160\144\x61\164\x65\x73"=>$r["\165\160\144\x61\164\x65\x73"],"\156\x65\x77\x65\163\x74"=>$r["\x63\x75\162\162\x65\156\164\137\166\x65\x72\163\x69\x6f\x6e"],"\x77\150\151\164\145"=>$r["\x77\150\151\164\145"],"\x70\141\143\153\141\x67\145"=>$r["\x70\141\143\153\141\x67\145"],"\x6c\141\156\x67"=>$r["\x6c\141\156\x67"]]);$sModel->setOption("\154\x69\x63\x65\x6e\x73\x65",["\x73\x74\141\164\x75\163"=>"\157\x6b"]);$ctime=86400*rand(1,5);}
cache()->save("\x73\171\163\164\x65\x6d",$system,$ctime);}else{$r=$this->encrypter($system,"\144");$r=json_decode($r,true);}
$this->noti($r,$sn->num);return $r;}
private function noti($r,$used){if(!$r)return;$sModel=new \App\Models\SettingsModel();$mc=config("\x4d\141\163\x74\x65\162\103\x6f\156\146\151\x67");if(!isset($mc->notify)||!isset($mc->notify["\x65\x6d\141\x69\154"]))return;$noti=$mc->notify;$this->data["\x6c\141\156\x67"]=isset($r["\x6c\141\156\x67"])?$r["\x6c\141\156\x67"]:"\145\156";if($r&&isset($r["\x73\x74\141\164\x75\163"])&&$r["\x73\x74\141\164\x75\163"]=="\x66\x61\151\x6c"){if(isset($r["\143\157\144\145"])){$lf=["\167\153","\x72\146","\167\x64"];if(in_array($r["\143\157\144\145"],$lf)&&$mc->notify["\x6c\x69\143\x65\x6e\163\x65\x45\162\162\157\162"]){if($noti["\x6c\x69\143\x65\x6e\163\x65\x45\162\162\157\162"]){$this->notisend($mc->notify["\x65\x6d\141\x69\154"],$this->ilang($r["\143\157\144\145"])[0],$this->ilang($r["\143\157\144\145"])[1],$r["\143\157\144\145"]);}
$lmes=$this->ilang($r["\143\157\144\145"])[1];$sModel->setOption("\154\x69\x63\x65\x6e\x73\x65",["\x73\x74\141\164\x75\163"=>"\x66\x61\151\x6c","\143\157\144\145"=>$r["\143\157\144\145"],"\x6d\145\163\163\141\147\x65"=>$lmes]);}}}
if(isset($r["\x61\154\x6c\157\167\145\144"])&&$r["\x61\154\x6c\157\167\145\144"]!="\55\61"){$left=$r["\x61\154\x6c\157\167\145\144"]-$used;$left=$left>0?$left:0;$code="\154\x72";if($left==0&&$noti["\x73\151\164\x65\x4c\x69\x6d\x69\164"]&&is_array($noti["\x73\151\164\x65\x4c\x69\x6d\x69\164"])&&in_array($left,$noti["\x73\151\164\x65\x4c\x69\x6d\x69\164"])){$this->notisend($mc->notify["\x65\x6d\141\x69\154"],$this->ilang($code)[0],$this->ilang($code)[1].$left."\56","\x73\154".$left);$lmes=$this->ilang($code)[1];$sModel->setOption("\154\x69\x63\x65\x6e\x73\x65",["\x73\x74\141\164\x75\163"=>"\x66\x61\151\x6c","\143\157\144\145"=>$code,"\x6d\145\163\163\141\147\x65"=>$lmes.$left]);}}}
private function ilang($code){$messages=["\145\156"=>["\167\153"=>["\114\x69\143\145\156\163\145\40\145\x72\162\x6f\x72\40\x65\156\x63\157\165\x6e\x74\x65\162\145\x64","\123\165\x70\x6c\151\x65\144\x20\x6b\x65\x79\x20\x69\x73\40\x69\156\x76\x61\x6c\x69\144\56\40\103\150\x65\143\153\40\155\141\156\x75\141\154\x20\146\157\162\x20\x6d\x6f\x72\x65\40\151\156\146\x6f\x72\x6d\141\164\151\157\156\x2e"],"\x72\146"=>["\114\x69\143\145\156\163\145\40\145\x72\162\x6f\x72\40\x65\156\x63\157\165\x6e\x74\x65\162\145\x64","\105\162\162\157\x72\x20\x63\x6f\x64\145\72\x20\162\x66\x2e\40\103\x6f\x6e\164\x61\143\x74\x20\163\165\160\160\157\162\164\x20\146\x6f\162\40\x6d\x6f\x72\145\x20\151\156\146\x6f\x72\155\141\164\x69\157\156\56"],"\167\x64"=>["\114\x69\143\145\156\163\145\40\145\x72\162\x6f\x72\40\x65\156\x63\157\165\x6e\x74\x65\162\145\x64","\x59\157\x75\162\40\x6c\x69\143\145\x6e\163\x65\x20\x6b\x65\x79\x20\151\163\40\141\x6c\162\x65\x61\x64\171\x20\x61\x63\x74\151\x76\141\164\145\144\40\x6f\156\40\x6f\164\150\145\162\x20\144\157\x6d\141\151\x6e\56"],"\154\x72"=>["\123\x69\x74\x65\x20\x6c\151\x6d\151\x74\x20\156\157\164\x69\146\151\x63\141\x74\x69\157\x6e","\123\151\164\145\x73\x20\x70\x6f\x73\x73\x69\x62\154\145\40\164\157\x20\x62\x65\x20\160\165\x62\x6c\151\163\150\145\x64\72\40"]],"\x70\154"=>["\167\153"=>["\x57\x79\163\x74\304\205\x70\151\305\x82\x20\x62\xc5\202\xc4\205\x64\40\154\151\143\x65\x6e\x63\152\x69","\x4b\x6c\x75\x63\172\x20\154\x69\x63\145\x6e\x63\x79\152\156\171\x20\x6a\x65\x73\164\x20\x6e\151\x65\160\x6f\x70\x72\141\167\x6e\x79\56\x20\120\162\x6f\x73\x7a\304\231\40\163\160\x72\x61\167\x64\x7a\x69\xc4\207\x20\x69\156\x73\x74\x72\x75\x6b\143\x6a\xc4\231\x20\160\x6f\x20\x77\x69\xc4\231\143\145\x6a\x20\151\156\146\x6f\x72\x6d\141\x63\x6a\151\x2e"],"\x72\146"=>["\x57\x79\163\x74\304\205\x70\151\305\x82\x20\x62\xc5\202\xc4\205\x64\40\154\151\143\x65\x6e\x63\152\x69","\113\157\x64\x20\142\xc5\x82\xc4\x99\144\165\x3a\x20\x72\x66\56\40\127\40\143\145\x6c\165\x20\x72\x6f\x7a\167\151\304\x85\172\141\156\151\x61\40\x70\162\x6f\142\x6c\x65\x6d\x75\x20\156\x61\x6c\145\305\xbc\171\x20\x73\x69\304\231\40\x73\x6b\x6f\156\164\141\153\164\157\167\141\304\207\40\172\40\157\x62\x73\305\202\165\147\xc4\205\40\x6b\154\x69\x65\156\164\x61\56"],"\167\x64"=>["\x57\x79\163\x74\304\205\x70\151\305\x82\x20\x62\xc5\202\xc4\205\x64\40\154\151\143\x65\x6e\x63\152\x69","\120\157\144\141\156\x79\40\153\x6c\165\143\172\x20\x6c\x69\x63\x65\x6e\143\x79\x6a\x6e\171\40\152\x65\x73\164\x20\x70\x72\x7a\x79\160\151\x73\x61\156\x79\x20\144\157\x20\x69\156\x6e\x65\x6a\40\x64\x6f\155\145\x6e\x79\x2e"],"\154\x72"=>["\x50\x6f\167\x69\141\x64\157\155\x69\x65\156\x69\x65\x20\x6f\x20\x6c\151\155\151\143\x69\145\x20\x73\164\162\x6f\x6e","\120\x6f\x7a\157\x73\164\141\xc5\x82\x61\x20\154\151\143\172\x62\141\x20\163\164\162\x6f\x6e\x20\x64\157\x20\x6f\x70\165\x62\154\151\x6b\157\167\141\x6e\151\x61\x3a\x20"]],];if(isset($messages[$this->data["\x6c\141\156\x67"]][$code])){return $messages[$this->data["\x6c\141\156\x67"]][$code];}
if(isset($messages["\145\156"][$code])){return $messages["\145\156"][$code];}
return['',''];}
private function notisend($email,$subject,$message,$code){$sModel=new \App\Models\SettingsModel();$nlog=$sModel->getOption("\156\157\164\151\146\171",true);if(!$nlog||$nlog["\143\157\144\145"]!=$code||$nlog["\164\x69\155\145"]<time()-8640){$sModel->setOption("\156\157\164\151\146\171",["\143\157\144\145"=>$code,"\164\x69\155\145"=>time()]);$data=["\x73\x65\x6e\x64\x54\157"=>$email,"\x73\165\142\152\145\x63\x74"=>$subject,"\x6d\145\163\163\141\147\x65"=>"\74\x70\76".$message."\x3c\57\160\x3e"];$mailer=newLib('Mails');$mailer->send($data);}}
private function encrypter($text,$action){$config=new \Config\Encryption();$config->key="\x39\x48\164\x37\132\x56\x6d\142\x76\x4c\x35\x43\122\103\x44\x6d\103\116\x63\162\115\164\63\115\x44\x44\71\63\156\x41\127\x75";$encrypter=\Config\Services::encrypter($config);if($action=='e'){return base64_encode($encrypter->encrypt($text));}else{return $encrypter->decrypt(base64_decode($text));}}
private function ask($lk,$sk){$d=parse_url(config("\101\160\x70")->baseURL)["\x68\157\163\x74"];$ch=curl_init();curl_setopt($ch,CURLOPT_URL,"\x68\164\x74\160\163\72\x2f\57\163\x69\164\145\153\154\171\56\x63\157\155\57\166\145\x72\151\146\x79");curl_setopt($ch,CURLOPT_POST,1);curl_setopt($ch,CURLOPT_POSTFIELDS,http_build_query(array("\x6c"=>$lk,"\144"=>$d,"\x73"=>$sk,"\151"=>$_SERVER["\x53\x45\122\x56\x45\x52\x5f\101\104\x44\122"])));curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);$server_output=curl_exec($ch);curl_close($ch);return $server_output;}
protected function copySite($mediaid,$newmediaid,$dir,$newDir,$type,$expire=null){$manager=newLib('MediaManager');$manager->connect($mediaid);$oldBase=$manager->config["\142\141\163\x65"]."\57".$dir."\57";$search=[$oldBase,str_replace("\57","\134\x2f",$oldBase)];$list=$manager->listAllFiles($dir);if(!isset($list["\x64\x69\x72\163"]))return dlog("\x69\155\147\x20\146\145\x74\143\x68\40\145\162\162\157\x72");$manager->connect($newmediaid);$newBase=$manager->config["\142\141\163\x65"]."\57".$newDir."\57";$replace=[$newBase,str_replace("\57","\134\x2f",$newBase)];$manager->copyAllFiles($newDir,$list);$FileManager=newLib('FileManager');$dest=($type=="\163\151\x74\145")?$FileManager->projectsRoot.$newDir:$FileManager->templatesRoot.$newDir;$FileManager->cloneSiteFiles($FileManager->templatesRoot.$dir,$dest,$search,$replace,$type);if($type=='site'){mkdir($dest.'/'.'draft');mkdir($dest.'/'.'draft/config');$manager->setStatus($newDir,$expire,'1');copy($FileManager->thumbsRoot.$dir.'/ico.jpg',$FileManager->projectThumbsRoot.$newDir.'.jpg');}else{$FileManager->cloneSiteFiles($FileManager->thumbsRoot.$dir,$FileManager->thumbsRoot.$newDir);}}}